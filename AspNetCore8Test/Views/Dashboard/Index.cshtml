@model dynamic

@{
    ViewData["Title"] = "天然氣公司管理系統 - 儀表板";
}

<div class="container-fluid">
    <!-- 頁面標題 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-tachometer-alt me-2"></i>系統儀表板</h2>
                <div class="text-muted">
                    <i class="fas fa-clock me-1"></i>
                    最後更新：<span id="lastUpdate">@DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss")</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 統計卡片 -->
    <div class="row mb-4">
        <!-- 客戶統計 -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                客戶總數
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.TotalCustomers</div>
                            <div class="mt-2 mb-0 text-muted text-xs">
                                <span class="text-success mr-2">
                                    <i class="fas fa-arrow-up"></i> @Model.ActiveCustomers 活躍
                                </span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 收入統計 -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                總收入
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">$@Model.TotalRevenue.ToString("N0")</div>
                            <div class="mt-2 mb-0 text-muted text-xs">
                                <span class="text-success mr-2">
                                    <i class="fas fa-check"></i> $@Model.PaidRevenue.ToString("N0") 已收
                                </span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 未付款統計 -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                未付款
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.UnpaidBills 筆</div>
                            <div class="mt-2 mb-0 text-muted text-xs">
                                <span class="text-warning mr-2">
                                    <i class="fas fa-exclamation-triangle"></i> $@Model.UnpaidAmount.ToString("N0")
                                </span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 警報統計 -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                活躍警報
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.ActiveAlerts</div>
                            <div class="mt-2 mb-0 text-muted text-xs">
                                <span class="text-danger mr-2">
                                    <i class="fas fa-bell"></i> @Model.CriticalAlerts 嚴重
                                </span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-bell fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 圖表區域 -->
    <div class="row mb-4">
        <!-- 收入趨勢圖 -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">收入趨勢</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 客戶類型分布 -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">客戶類型分布</h6>
                </div>
                <div class="card-body">
                    <div class="chart-pie pt-4 pb-2">
                        <canvas id="customerChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 詳細資訊區域 -->
    <div class="row">
        <!-- 最近客戶 -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">最近註冊客戶</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-borderless">
                            @foreach (var customer in Model.RecentCustomers)
                            {
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="mr-3">
                                                <div class="icon-circle bg-primary">
                                                    <i class="fas fa-user text-white"></i>
                                                </div>
                                            </div>
                                            <div>
                                                <div class="small">@customer.Name</div>
                                                <div class="small text-gray-500">@customer.CustomerNumber - @customer.Type</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-right">
                                        <div class="small text-gray-500">@customer.RegisterDate.ToString("MM/dd")</div>
                                    </td>
                                </tr>
                            }
                        </table>
                    </div>
                    <div class="text-center">
                        <a asp-controller="Customer" asp-action="Index" class="btn btn-primary btn-sm">
                            查看所有客戶 <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 最近警報 -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">最近警報</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-borderless">
                            @foreach (var alert in Model.RecentAlerts)
                            {
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="mr-3">
                                                <div class="icon-circle bg-@(alert.Severity == "Critical" ? "danger" : alert.Severity == "High" ? "warning" : "info")">
                                                    <i class="fas fa-bell text-white"></i>
                                                </div>
                                            </div>
                                            <div>
                                                <div class="small">@alert.Title</div>
                                                <div class="small text-gray-500">@alert.PipelineName</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-right">
                                        <div class="small text-gray-500">@alert.AlertTime.ToString("MM/dd HH:mm")</div>
                                    </td>
                                </tr>
                            }
                        </table>
                    </div>
                    <div class="text-center">
                        <a asp-controller="Pipeline" asp-action="Alerts" class="btn btn-warning btn-sm">
                            查看所有警報 <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 快速操作區域 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">快速操作</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3 mb-3">
                            <a asp-controller="Customer" asp-action="Create" class="btn btn-outline-primary btn-lg btn-block">
                                <i class="fas fa-user-plus fa-2x mb-2"></i>
                                <br>新增客戶
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a asp-controller="Billing" asp-action="Create" class="btn btn-outline-success btn-lg btn-block">
                                <i class="fas fa-file-invoice fa-2x mb-2"></i>
                                <br>建立帳單
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a asp-controller="Pipeline" asp-action="Monitoring" class="btn btn-outline-info btn-lg btn-block">
                                <i class="fas fa-chart-line fa-2x mb-2"></i>
                                <br>管線監控
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a asp-controller="Billing" asp-action="Unpaid" class="btn btn-outline-warning btn-lg btn-block">
                                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                <br>未付款管理
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .border-left-primary {
            border-left: 0.25rem solid #4e73df !important;
        }
        
        .border-left-success {
            border-left: 0.25rem solid #1cc88a !important;
        }
        
        .border-left-warning {
            border-left: 0.25rem solid #f6c23e !important;
        }
        
        .border-left-danger {
            border-left: 0.25rem solid #e74a3b !important;
        }
        
        .icon-circle {
            height: 2.5rem;
            width: 2.5rem;
            border-radius: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .text-gray-300 {
            color: #dddfeb !important;
        }
        
        .text-gray-500 {
            color: #858796 !important;
        }
        
        .text-gray-800 {
            color: #5a5c69 !important;
        }
    </style>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let revenueChart, customerChart;

        // 初始化圖表
        function initCharts() {
            initRevenueChart();
            initCustomerChart();
        }

        // 初始化收入趨勢圖
        function initRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            fetch('@Url.Action("GetChartData", "Dashboard")?chartType=revenue')
                .then(response => response.json())
                .then(data => {
                    revenueChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(d => d.month),
                            datasets: [{
                                label: '總金額',
                                data: data.map(d => d.total),
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.1
                            }, {
                                label: '已收款',
                                data: data.map(d => d.paid),
                                borderColor: 'rgb(54, 162, 235)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '$' + value.toLocaleString();
                                        }
                                    }
                                }
                            }
                        }
                    });
                });
        }

        // 初始化客戶類型圖
        function initCustomerChart() {
            const ctx = document.getElementById('customerChart').getContext('2d');
            
            fetch('@Url.Action("GetChartData", "Dashboard")?chartType=customers')
                .then(response => response.json())
                .then(data => {
                    customerChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: data.map(d => d.type),
                            datasets: [{
                                data: data.map(d => d.count),
                                backgroundColor: [
                                    '#4e73df',
                                    '#1cc88a',
                                    '#36b9cc',
                                    '#f6c23e',
                                    '#e74a3b'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                });
        }

        // 更新時間顯示
        function updateTime() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-TW');
        }

        // 自動重新整理統計數據
        function refreshStats() {
            fetch('@Url.Action("GetSystemStats", "Dashboard")')
                .then(response => response.json())
                .then(data => {
                    // 這裡可以更新頁面上的統計數據
                    console.log('Stats updated:', data);
                });
        }

        // 頁面載入完成後執行
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            
            // 每30秒更新一次時間和統計
            setInterval(function() {
                updateTime();
                refreshStats();
            }, 30000);
        });
    </script>
}