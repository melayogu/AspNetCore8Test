@model AspNetCore8Test.Models.DTOs.GasDTOs.LoRaDashboardViewModel

@{
    ViewData["Title"] = "LoRa 無線抄表系統";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-0">
            <i class="fas fa-broadcast-tower me-2 text-primary"></i>LoRa 無線抄表系統儀表板
        </h2>
        <small class="text-muted">資料更新時間：@Model.Overview.GeneratedAt.ToString("yyyy/MM/dd HH:mm")</small>
    </div>
    <div class="btn-group">
        <a asp-action="Devices" class="btn btn-outline-primary">
            <i class="fas fa-microchip me-1"></i>裝置清單
        </a>
        <a asp-action="Readings" class="btn btn-outline-secondary">
            <i class="fas fa-stream me-1"></i>最新傳輸
        </a>
        <a asp-action="Alerts" class="btn btn-outline-danger">
            <i class="fas fa-exclamation-triangle me-1"></i>警報中心
        </a>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-muted text-uppercase">總裝置數</h6>
                        <h2 class="fw-bold">@Model.Overview.TotalDevices</h2>
                        <span class="badge bg-success">
                            啟用 @Model.Overview.ActiveDevices 台
                        </span>
                    </div>
                    <i class="fas fa-microchip fa-2x text-primary"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-muted text-uppercase">24 小時傳輸</h6>
                        <h2 class="fw-bold">@Model.Overview.DailyReadings</h2>
                        <span class="text-muted">本月累計 @Model.Overview.MonthlyReadings 筆</span>
                    </div>
                    <i class="fas fa-stream fa-2x text-info"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-muted text-uppercase">網路覆蓋率</h6>
                        <h2 class="fw-bold">@Model.Overview.CoveragePercentage.ToString("F1")<small class="fs-5">%</small></h2>
                        <span class="text-muted">閘道器 @Model.Overview.GatewayCount 台</span>
                    </div>
                    <i class="fas fa-wifi fa-2x text-success"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-muted text-uppercase">待處理警報</h6>
                        <h2 class="fw-bold text-danger">@Model.Overview.AlertDevices</h2>
                        <span class="text-muted">24 小時新增 @Model.Overview.RecentAlertCount 件</span>
                    </div>
                    <i class="fas fa-exclamation-circle fa-2x text-danger"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase mb-2">平均訊號</h6>
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">@Model.Overview.AverageSignalStrength.ToString("F1") dBm</h3>
                    <i class="fas fa-signal text-primary fa-2x"></i>
                </div>
                <small class="text-muted">顯示所有 LoRa 裝置之平均 RSSI</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase mb-2">封包成功率</h6>
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">@Model.Overview.PacketSuccessRate.ToString("F2")%</h3>
                    <i class="fas fa-envelope-open-text text-success fa-2x"></i>
                </div>
                <small class="text-muted">閘道器平均封包成功率</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase mb-2">低電量裝置</h6>
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">@Model.Overview.BatteryCriticalCount 台</h3>
                    <i class="fas fa-battery-quarter text-warning fa-2x"></i>
                </div>
                <small class="text-muted">電量低於 20% 的裝置需派遣人員</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase mb-2">待升級韌體</h6>
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">@Model.Overview.FirmwareOutdatedCount 台</h3>
                    <i class="fas fa-microchip text-secondary fa-2x"></i>
                </div>
                <small class="text-muted">可遠端派送最新韌體版本</small>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-8">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">區域覆蓋率與訊號品質</h5>
                    <small class="text-muted">以行政區域統計 LoRa 網路表現</small>
                </div>
                <div class="btn-group btn-group-sm" role="group" aria-label="Charts toggle">
                    <button class="btn btn-outline-primary active" id="btnCoverage">覆蓋率</button>
                    <button class="btn btn-outline-secondary" id="btnSignal">訊號品質</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="networkChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0">活躍警報</h5>
                <small class="text-muted">最近 6 筆尚未結案之警報</small>
            </div>
            <div class="card-body">
                @if (Model.ActiveAlerts.Any())
                {
                    <div class="list-group list-group-flush">
                        @foreach (var alert in Model.ActiveAlerts)
                        {
                            <a asp-action="DeviceDetails" asp-route-id="@alert.DeviceId" class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">
                                        <span class="badge bg-@(alert.Severity == "High" ? "danger" : alert.Severity == "Medium" ? "warning" : "info") me-2">@alert.Severity</span>
                                        @alert.AlertType
                                    </h6>
                                    <small class="text-muted">@alert.DetectedAt.ToString("MM/dd HH:mm")</small>
                                </div>
                                <p class="mb-1 text-muted">@alert.Description</p>
                                <small class="text-muted">裝置：@alert.DeviceNumber (@alert.CustomerName)</small>
                            </a>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                        <p class="mb-0">目前沒有待處理警報</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0">訊號表現最佳的裝置</h5>
                <small class="text-muted">依 RSSI 排序的前五名裝置</small>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>裝置編號</th>
                                <th>客戶</th>
                                <th>RSSI (dBm)</th>
                                <th>電量</th>
                                <th>最後傳輸</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var device in Model.TopDevices)
                            {
                                <tr>
                                    <td>
                                        <a asp-action="DeviceDetails" asp-route-id="@device.Id" class="fw-semibold text-decoration-none">
                                            @device.DeviceNumber
                                        </a>
                                    </td>
                                    <td>@device.CustomerName</td>
                                    <td>@device.SignalStrength.ToString("F1")</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                                <div class="progress-bar bg-@(device.BatteryLevel < 25 ? "danger" : device.BatteryLevel < 50 ? "warning" : "success")"
                                                     role="progressbar" style="width: @device.BatteryLevel%"></div>
                                            </div>
                                            <small>@device.BatteryLevel%</small>
                                        </div>
                                    </td>
                                    <td>@device.LastReadingTime.ToString("MM/dd HH:mm")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0">閘道器運作狀態</h5>
                <small class="text-muted">目前接入之 LoRa 閘道器</small>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>閘道器</th>
                                <th>區域</th>
                                <th>狀態</th>
                                <th>連線裝置</th>
                                <th>封包成功率</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var gateway in Model.Gateways)
                            {
                                <tr>
                                    <td>@gateway.GatewayId</td>
                                    <td>@gateway.Region</td>
                                    <td>
                                        <span class="badge bg-@(gateway.Status == "Online" ? "success" : gateway.Status == "Maintenance" ? "warning" : "secondary")">
                                            @gateway.Status
                                        </span>
                                    </td>
                                    <td>@gateway.ConnectedDevices</td>
                                    <td>@gateway.PacketSuccessRate.ToString("F2")%</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white border-0">
        <h5 class="mb-0">最新傳輸紀錄</h5>
        <small class="text-muted">最近 10 筆由 LoRa 裝置回傳的抄錶資料</small>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>時間</th>
                        <th>裝置</th>
                        <th>客戶</th>
                        <th class="text-end">讀值</th>
                        <th class="text-end">用量</th>
                        <th>RSSI</th>
                        <th>SNR</th>
                        <th>狀態</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var reading in Model.RecentReadings)
                    {
                        <tr>
                            <td>@reading.ReadingTime.ToString("yyyy/MM/dd HH:mm")</td>
                            <td>
                                <a asp-action="DeviceDetails" asp-route-id="@reading.DeviceId" class="text-decoration-none fw-semibold">
                                    @reading.DeviceNumber
                                </a>
                            </td>
                            <td>@reading.CustomerName</td>
                            <td class="text-end">@reading.ReadingValue.ToString("N2") m³</td>
                            <td class="text-end">@reading.Usage.ToString("N2") m³</td>
                            <td>@reading.SignalStrength.ToString("F1") dBm</td>
                            <td>@reading.Snr.ToString("F1") dB</td>
                            <td>
                                <span class="badge bg-@(reading.IsAlert ? "danger" : reading.TransmissionStatus == "Delivered" ? "success" : "warning")">
                                    @(reading.IsAlert ? "異常" : reading.TransmissionStatus)
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .list-group-item-action:hover {
            background-color: #f8f9fa;
        }
    </style>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const chartElement = document.getElementById('networkChart');
            const coverageButton = document.getElementById('btnCoverage');
            const signalButton = document.getElementById('btnSignal');

            if (!chartElement) {
                return;
            }

            const regions = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.NetworkStatus.Select(n => n.Region)));
            const coverageData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.NetworkStatus.Select(n => n.CoverageRate)));
            const signalData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.NetworkStatus.Select(n => n.AverageSignalStrength)));
            const successData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.NetworkStatus.Select(n => n.PacketSuccessRate)));

            let currentChart;

            function buildCoverageChart() {
                const ctx = chartElement.getContext('2d');
                currentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: regions,
                        datasets: [
                            {
                                label: '覆蓋率 (%)',
                                data: coverageData,
                                backgroundColor: 'rgba(25, 135, 84, 0.6)',
                                borderColor: 'rgba(25, 135, 84, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '封包成功率 (%)',
                                data: successData,
                                backgroundColor: 'rgba(13, 110, 253, 0.6)',
                                borderColor: 'rgba(13, 110, 253, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
                coverageButton.classList.add('active');
                signalButton.classList.remove('active');
            }

            function buildSignalChart() {
                const ctx = chartElement.getContext('2d');
                currentChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: regions,
                        datasets: [
                            {
                                label: '平均 RSSI (dBm)',
                                data: signalData,
                                borderColor: 'rgba(220, 53, 69, 0.9)',
                                backgroundColor: 'rgba(220, 53, 69, 0.2)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                reverse: true,
                                suggestedMin: -95,
                                suggestedMax: -70
                            }
                        }
                    }
                });
                signalButton.classList.add('active');
                coverageButton.classList.remove('active');
            }

            function rebuildChart(builder) {
                if (currentChart) {
                    currentChart.destroy();
                }
                builder();
            }

            coverageButton.addEventListener('click', function () {
                rebuildChart(buildCoverageChart);
            });

            signalButton.addEventListener('click', function () {
                rebuildChart(buildSignalChart);
            });

            buildCoverageChart();
        });
    </script>
}
