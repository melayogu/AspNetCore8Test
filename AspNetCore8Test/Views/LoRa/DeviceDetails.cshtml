@model AspNetCore8Test.Models.DTOs.GasDTOs.LoRaDeviceDetailsViewModel

@{
    ViewData["Title"] = $"LoRa 裝置詳情 - {Model.Device.DeviceNumber}";
    var chartOptions = new System.Text.Json.JsonSerializerOptions
    {
        PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase
    };
    var readingsJson = System.Text.Json.JsonSerializer.Serialize(Model.RecentReadings.OrderBy(r => r.ReadingTime), chartOptions);
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-0">
            <i class="fas fa-microchip me-2 text-primary"></i>@Model.Device.DeviceNumber
        </h2>
        <small class="text-muted">啟用日期：@Model.Device.ActivatedAt.ToString("yyyy/MM/dd") · 目前狀態：@Model.Device.Status</small>
    </div>
    <div class="btn-group" role="group">
        <a asp-action="Devices" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>返回裝置列表
        </a>
        <a asp-action="Readings" asp-route-deviceId="@Model.Device.Id" class="btn btn-outline-primary">
            <i class="fas fa-stream me-1"></i>查看傳輸紀錄
        </a>
        <a asp-action="Alerts" class="btn btn-outline-danger">
            <i class="fas fa-exclamation-triangle me-1"></i>警報中心
        </a>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-8">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0">裝置即時指標</h5>
                <small class="text-muted">最近一次傳輸時間：@Model.Device.LastReadingTime.ToString("yyyy/MM/dd HH:mm")</small>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="border rounded p-3 h-100 bg-light">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted text-uppercase">目前狀態</span>
                                <span class="badge bg-@(Model.Device.Status == "Active" ? "success" : Model.Device.Status == "Maintenance" ? "warning" : "secondary")">@Model.Device.Status</span>
                            </div>
                            <p class="mb-1"><strong>客戶：</strong>@Model.Device.CustomerName</p>
                            <p class="mb-1"><strong>裝置位置：</strong>@Model.Device.Address</p>
                            <p class="mb-0"><strong>安裝型式：</strong>@Model.Device.InstallationType</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="border rounded p-3 h-100 bg-light">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted text-uppercase">連線品質</span>
                                <span class="badge bg-info">@Model.Device.GatewayId</span>
                            </div>
                            <p class="mb-1"><strong>RSSI：</strong>@Model.Device.SignalStrength.ToString("F1") dBm</p>
                            <p class="mb-1"><strong>SNR：</strong>@Model.Device.Snr.ToString("F1") dB</p>
                            <p class="mb-0"><strong>封包狀態：</strong>@(Model.Device.HasRecentAlert ? Model.Device.AlertStatus : "正常")</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="border rounded p-3 h-100 bg-light">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted text-uppercase">能源狀態</span>
                                <i class="fas fa-battery-half text-warning"></i>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <div class="progress flex-grow-1 me-2" style="height: 10px;">
                                    <div class="progress-bar bg-@(Model.Device.BatteryLevel < 25 ? "danger" : Model.Device.BatteryLevel < 50 ? "warning" : "success")" role="progressbar" style="width: @Model.Device.BatteryLevel%"></div>
                                </div>
                                <strong>@Model.Device.BatteryLevel%</strong>
                            </div>
                            <p class="mb-1"><strong>本月用量：</strong>@Model.Device.MonthlyUsage.ToString("N2") m³</p>
                            <p class="mb-0"><strong>最近讀值：</strong>@Model.Device.LastReadingValue.ToString("N2") m³</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="border rounded p-3 h-100 bg-light">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted text-uppercase">韌體與維運</span>
                                <i class="fas fa-tools text-secondary"></i>
                            </div>
                            <p class="mb-1"><strong>韌體版本：</strong>@Model.Device.FirmwareVersion</p>
                            <p class="mb-1"><strong>韌體狀態：</strong>
                                <span class="badge bg-@(Model.Device.FirmwareUpToDate ? "info" : "secondary")">
                                    @(Model.Device.FirmwareUpToDate ? "最新" : "需更新")
                                </span>
                            </p>
                            <p class="mb-0"><strong>近 24 小時異常：</strong>@(Model.Device.HasRecentAlert ? "有" : "無")</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0">裝置識別</h5>
                <small class="text-muted">序號與關聯資訊</small>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-5 text-muted">裝置編號</dt>
                    <dd class="col-7 fw-semibold">@Model.Device.DeviceNumber</dd>
                    <dt class="col-5 text-muted">計量錶</dt>
                    <dd class="col-7">@Model.Device.MeterNumber</dd>
                    <dt class="col-5 text-muted">閘道器</dt>
                    <dd class="col-7">@Model.Device.GatewayId</dd>
                    <dt class="col-5 text-muted">安裝型式</dt>
                    <dd class="col-7">@Model.Device.InstallationType</dd>
                    <dt class="col-5 text-muted">客戶</dt>
                    <dd class="col-7">@Model.Device.CustomerName</dd>
                    <dt class="col-5 text-muted">地址</dt>
                    <dd class="col-7">@Model.Device.Address</dd>
                </dl>
                <hr />
                <p class="mb-1"><strong>狀態摘要：</strong> @(Model.Device.HasRecentAlert ? "需注意" : "穩定")</p>
                <p class="mb-0"><strong>最後活動：</strong> @Model.Device.LastReadingTime.ToString("MM/dd HH:mm")</p>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-8">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0">近 48 筆傳輸趨勢</h5>
                <small class="text-muted">顯示抄錶讀值與訊號變化</small>
            </div>
            <div class="card-body">
                <canvas id="readingChart" height="240"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0">警報紀錄</h5>
                <small class="text-muted">此裝置相關的警報事件</small>
            </div>
            <div class="card-body">
                @if (Model.Alerts.Any())
                {
                    <div class="list-group list-group-flush">
                        @foreach (var alert in Model.Alerts.Take(6))
                        {
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between">
                                    <span class="badge bg-@(alert.Severity == "High" ? "danger" : alert.Severity == "Medium" ? "warning" : "info")">@alert.Severity</span>
                                    <small class="text-muted">@alert.DetectedAt.ToString("MM/dd HH:mm")</small>
                                </div>
                                <h6 class="mt-2 mb-1">@alert.AlertType</h6>
                                <p class="mb-1 text-muted small">@alert.Description</p>
                                <small class="text-muted">狀態：@alert.Status</small>
                                @if (!string.IsNullOrEmpty(alert.RecommendedAction))
                                {
                                    <div class="mt-1 small text-muted">建議：@alert.RecommendedAction</div>
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                        <p class="mb-0">此裝置近期無警報紀錄</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white border-0">
        <h5 class="mb-0">最新傳輸紀錄</h5>
        <small class="text-muted">最近 40 筆 LoRa 傳輸詳細資料</small>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-light">
                    <tr>
                        <th>時間</th>
                        <th class="text-end">讀值 (m³)</th>
                        <th class="text-end">用量 (m³)</th>
                        <th>RSSI</th>
                        <th>SNR</th>
                        <th>封包狀態</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var reading in Model.RecentReadings)
                    {
                        <tr>
                            <td>@reading.ReadingTime.ToString("yyyy/MM/dd HH:mm")</td>
                            <td class="text-end">@reading.ReadingValue.ToString("N2")</td>
                            <td class="text-end">@reading.Usage.ToString("N2")</td>
                            <td>@reading.SignalStrength.ToString("F1") dBm</td>
                            <td>@reading.Snr.ToString("F1") dB</td>
                            <td>
                                <span class="badge bg-@(reading.IsAlert ? "danger" : reading.TransmissionStatus == "Delivered" ? "success" : "warning")">
                                    @(reading.IsAlert ? reading.AlertType : reading.TransmissionStatus)
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const chartElement = document.getElementById('readingChart');
            if (!chartElement) {
                return;
            }

            const readings = @Html.Raw(readingsJson);
            const labels = readings.map(r => new Date(r.readingTime).toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }));
            const values = readings.map(r => r.readingValue);
            const signals = readings.map(r => r.signalStrength);

            new Chart(chartElement.getContext('2d'), {
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'line',
                            label: '讀值 (m³)',
                            data: values,
                            borderColor: 'rgba(13, 110, 253, 0.9)',
                            backgroundColor: 'rgba(13, 110, 253, 0.2)',
                            tension: 0.3,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            type: 'line',
                            label: 'RSSI (dBm)',
                            data: signals,
                            borderColor: 'rgba(220, 53, 69, 0.9)',
                            backgroundColor: 'rgba(220, 53, 69, 0.15)',
                            tension: 0.3,
                            fill: true,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    stacked: false,
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left'
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            reverse: true,
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        });
    </script>
}
