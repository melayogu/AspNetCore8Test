@model IEnumerable<AspNetCore8Test.Models.DTOs.GasDTOs.LoRaReadingDto>
@{
    var readings = Model.OrderByDescending(r => r.ReadingTime).ToList();
    var device = ViewBag.Device as AspNetCore8Test.Models.DTOs.GasDTOs.LoRaDeviceDto;
    ViewData["Title"] = device != null ? $"LoRa 傳輸紀錄 - {device.DeviceNumber}" : "LoRa 傳輸紀錄";
    var deliveredCount = readings.Count(r => string.Equals(r.TransmissionStatus, "Delivered", StringComparison.OrdinalIgnoreCase));
    var alertCount = readings.Count(r => r.IsAlert);
    var averageRssi = readings.Any() ? readings.Average(r => r.SignalStrength) : 0;
    var averageSnr = readings.Any() ? readings.Average(r => r.Snr) : 0;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-0">
            <i class="fas fa-stream me-2 text-info"></i>@(device != null ? $"{device.DeviceNumber} 傳輸紀錄" : "LoRa 傳輸紀錄")
        </h2>
        @if (device != null)
        {
            <small class="text-muted">客戶：@device.CustomerName · 位置：@device.Address</small>
        }
        else
        {
            <small class="text-muted">共 @readings.Count 筆傳輸紀錄</small>
        }
    </div>
    <div class="btn-group">
        <a asp-action="Index" class="btn btn-outline-secondary"><i class="fas fa-tachometer-alt me-1"></i>儀表板</a>
        <a asp-action="Devices" class="btn btn-outline-primary"><i class="fas fa-microchip me-1"></i>裝置清單</a>
        <a asp-action="Alerts" class="btn btn-outline-danger"><i class="fas fa-exclamation-triangle me-1"></i>警報中心</a>
        @if (device != null)
        {
            <a asp-action="DeviceDetails" asp-route-id="@device.Id" class="btn btn-outline-info"><i class="fas fa-eye me-1"></i>裝置詳情</a>
        }
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase">總筆數</h6>
                <h2 class="mb-0">@readings.Count</h2>
                <small class="text-muted">收集自 LoRa 無線網路</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase">成功傳輸</h6>
                <h2 class="mb-0 text-success">@deliveredCount</h2>
                <small class="text-muted">成功率 @(readings.Count > 0 ? (deliveredCount / (double)readings.Count * 100).ToString("F1") : "0.0")%</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase">平均 RSSI</h6>
                <h2 class="mb-0">@averageRssi.ToString("F1") dBm</h2>
                <small class="text-muted">平均 SNR：@averageSnr.ToString("F1") dB</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase">異常事件</h6>
                <h2 class="mb-0 text-danger">@alertCount</h2>
                <small class="text-muted">包含低電量與訊號異常</small>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>時間</th>
                        @if (device == null)
                        {
                            <th>裝置</th>
                            <th>客戶</th>
                        }
                        <th class="text-end">讀值 (m³)</th>
                        <th class="text-end">用量 (m³)</th>
                        <th>RSSI</th>
                        <th>SNR</th>
                        <th>電量</th>
                        <th>封包狀態</th>
                        <th>警報</th>
                    </tr>
                </thead>
                <tbody>
                    @if (readings.Any())
                    {
                        foreach (var reading in readings)
                        {
                            <tr class="@(reading.IsAlert ? "table-warning" : string.Empty)">
                                <td>@reading.ReadingTime.ToString("yyyy/MM/dd HH:mm")</td>
                                @if (device == null)
                                {
                                    <td>
                                        <a asp-action="DeviceDetails" asp-route-id="@reading.DeviceId" class="text-decoration-none fw-semibold">
                                            @reading.DeviceNumber
                                        </a>
                                    </td>
                                    <td>@reading.CustomerName</td>
                                }
                                <td class="text-end">@reading.ReadingValue.ToString("N2")</td>
                                <td class="text-end">@reading.Usage.ToString("N2")</td>
                                <td>@reading.SignalStrength.ToString("F1") dBm</td>
                                <td>@reading.Snr.ToString("F1") dB</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                            <div class="progress-bar bg-@(reading.BatteryLevel < 25 ? "danger" : reading.BatteryLevel < 50 ? "warning" : "success")" role="progressbar" style="width: @reading.BatteryLevel%"></div>
                                        </div>
                                        <small>@reading.BatteryLevel%</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-@(string.Equals(reading.TransmissionStatus, "Delivered", StringComparison.OrdinalIgnoreCase) ? "success" : "warning")">
                                        @reading.TransmissionStatus
                                    </span>
                                </td>
                                <td>
                                    @if (reading.IsAlert)
                                    {
                                        <span class="badge bg-danger">@reading.AlertType</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">正常</span>
                                    }
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="@(device == null ? 9 : 7)" class="text-center text-muted py-4">
                                <i class="fas fa-info-circle fa-2x mb-2"></i>
                                <p class="mb-0">目前沒有傳輸紀錄</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
